---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import ArticleHeader from '../components/ArticleHeader.astro';
import ArticleBody from '../components/ArticleBody.astro';
import Quote from '../components/Quote.astro';
import SecondaryArticle from '../components/SecondaryArticle.astro';
import Navbar from '../components/Navbar.astro';
import MarketTicker from '../components/MarketTicker.astro';
import SidebarNews from '../components/SidebarNews.astro';
import LatestNews from '../components/LatestNews.astro';
import Footer from '../components/Footer.astro';
import { marked } from 'marked';

// Fetch all articles at build/request time
const [mainResponse, secondaryResponse] = await Promise.all([
  fetch(new URL("/api/main-article", Astro.url)),
  fetch(new URL("/api/secondary-articles", Astro.url))
]);

const featuredArticle = await mainResponse.json();
const secondaryArticles = await secondaryResponse.json();

const today = new Date().toLocaleDateString('en-US', {
  month: 'long',
  day: 'numeric',
  year: 'numeric'
});
---

<Layout title="The Wall Chain Journal - Breaking Blockchain News and Analysis">
  <Navbar />
  <MarketTicker />
  <Header />
  
  <main class="grid grid-cols-12 gap-8 max-w-7xl mx-auto px-4 py-8">
    <div class="col-span-8">
      <ArticleHeader 
        title={featuredArticle.title}
        author={featuredArticle.author}
        date={today}
        readTime={featuredArticle.readTime}
        category={featuredArticle.category}
      />
      
      <ArticleBody location={featuredArticle?.location}>
        {featuredArticle.content.map(section => (
          section.type === 'quote' 
            ? <Quote speaker={section.speaker}>{section.text}</Quote>
            : <p class="my-6">{section.text}</p>
        ))}
      </ArticleBody>
    </div>
    <aside class="col-span-4">
      <SidebarNews>
      </SidebarNews>
    </aside>
  </main>

  {/* Secondary stories section */}
  <section class="bg-gray-50 py-12">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-sm font-serif uppercase tracking-wider text-gray-600 mb-8">More Top Stories</h2>
      <div class="grid grid-cols-3 gap-8">
        {secondaryArticles.map((article) => (
          <SecondaryArticle
            title={article.title}
            author={article.author}
            date={today}
            category={article.category}
            readTime={article.readTime}
          >
            <div set:html={marked(article.content)} />
          </SecondaryArticle>
        ))}
      </div>
    </div>
  </section>

  <Footer />
</Layout>